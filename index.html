<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨˜å¸³æœ¬ (ç¸½æ­·å²ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase Compat SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #eee; }
        .app-container { font-family: 'Quicksand', 'Noto Sans TC', sans-serif; background-color: #F9F9F7; max-width: 450px; margin: 0 auto; height: 100vh; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .soft-shadow { box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .page { display: none; height: 100%; width: 100%; flex-direction: column; }
        .page.active { display: flex; }
        .modal-enter { animation: slideUp 0.3s ease-out forwards; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="app-container sm:rounded-[30px] sm:my-5 sm:h-[850px] sm:shadow-2xl">

        <!-- 1. ç™»å…¥é  -->
        <div id="page-login" class="page active items-center justify-center p-8 bg-[#F9F9F7] z-50">
            <div class="text-center mb-10">
                <div class="w-20 h-20 bg-white rounded-2xl mx-auto mb-4 flex items-center justify-center soft-shadow text-[#84A98C]"><i class="fa-solid fa-lock text-4xl"></i></div>
                <h1 class="text-2xl font-bold text-gray-700">è¨˜å¸³æœ¬</h1>
                <p class="text-xs text-gray-400 mt-2">å°ˆå±¬è¨ªå•æ¬Šé™</p>
            </div>
            <div class="w-full space-y-4">
                <input type="text" id="login-id" class="w-full p-4 rounded-xl bg-white outline-none text-gray-700 soft-shadow font-bold" placeholder="è¼¸å…¥å°ˆå±¬å¸³è™Ÿ ID">
                <input type="number" id="login-pin" class="w-full p-4 rounded-xl bg-white outline-none text-gray-700 soft-shadow font-bold" placeholder="è¼¸å…¥å¯†ç¢¼">
                <button onclick="handleLogin()" id="btn-login" class="w-full py-4 bg-[#84A98C] text-white rounded-xl font-bold soft-shadow mt-6">é©—è­‰èº«åˆ†</button>
                <p id="login-msg" class="text-center text-xs text-red-400 min-h-[20px] mt-2"></p>
            </div>
        </div>

        <!-- 2. é¸è§’é  -->
        <div id="page-role" class="page items-center justify-center p-8 bg-[#F9F9F7]">
            <h2 class="text-xl font-bold text-gray-600 mb-8">ä½ æ˜¯èª°ï¼Ÿ</h2>
            <button onclick="selectRole('Boy')" class="w-full py-6 bg-white rounded-2xl mb-4 soft-shadow flex items-center px-6 gap-4 border-2 border-transparent hover:border-[#84A98C]">
                <div class="w-12 h-12 rounded-full bg-[#E9F5DB] flex items-center justify-center text-[#84A98C] text-xl"><i class="fa-solid fa-person"></i></div>
                <span class="font-bold text-gray-700">æˆ‘æ˜¯ ç”·ç”Ÿ</span>
            </button>
            <button onclick="selectRole('Girl')" class="w-full py-6 bg-white rounded-2xl soft-shadow flex items-center px-6 gap-4 border-2 border-transparent hover:border-[#E5989B]">
                <div class="w-12 h-12 rounded-full bg-[#FFDFD3] flex items-center justify-center text-[#E5989B] text-xl"><i class="fa-solid fa-person-dress"></i></div>
                <span class="font-bold text-gray-700">æˆ‘æ˜¯ å¥³ç”Ÿ</span>
            </button>
        </div>

        <!-- 3. ä¸»ç•«é¢ (è¨˜å¸³) -->
        <div id="page-main" class="page relative">
            <header class="pt-10 pb-6 px-6 bg-white rounded-b-[35px] soft-shadow z-10 relative">
                <div class="flex justify-between items-center mb-4">
                    <div class="text-xs font-bold text-gray-400 tracking-widest">è¨˜å¸³æœ¬</div>
                    <div class="flex gap-4 items-center">
                        <button onclick="showPage('page-smoke')" id="btn-go-smoke" class="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center">
                            <i class="fa-solid fa-smoking"></i>
                        </button>
                        <button onclick="logout()" class="text-gray-300 hover:text-red-400 w-8 h-8 flex items-center justify-center z-50">
                            <i class="fa-solid fa-right-from-bracket"></i>
                        </button>
                    </div>
                </div>
                <div class="flex justify-center gap-8 mb-6">
                    <div onclick="switchView('Boy')" id="avatar-Boy" class="opacity-50 transition transform scale-90 flex flex-col items-center cursor-pointer">
                        <div class="w-14 h-14 rounded-full border-2 border-[#84A98C] p-1"><div class="w-full h-full bg-[#84A98C] rounded-full flex items-center justify-center text-white"><i class="fa-solid fa-person"></i></div></div>
                    </div>
                    <div onclick="switchView('Girl')" id="avatar-Girl" class="opacity-50 transition transform scale-90 flex flex-col items-center cursor-pointer">
                        <div class="w-14 h-14 rounded-full border-2 border-[#E5989B] p-1"><div class="w-full h-full bg-[#E5989B] rounded-full flex items-center justify-center text-white"><i class="fa-solid fa-person-dress"></i></div></div>
                    </div>
                </div>
                <div class="text-center">
                    <h1 id="total-balance" class="text-4xl font-bold text-gray-700 mb-2">0</h1>
                    <p class="text-xs text-gray-400">æœ¬æœˆçµé¤˜</p>
                </div>
            </header>
            
            <main id="tx-list" class="flex-1 overflow-y-auto no-scrollbar px-5 pt-4 pb-24 space-y-3">
                <div class="text-center text-gray-300 text-xs mt-10">è¼‰å…¥ä¸­...</div>
            </main>

            <div class="absolute bottom-6 w-full flex justify-center z-20">
                <button onclick="openModal()" id="fab-add" class="w-16 h-16 rounded-full shadow-lg text-white text-2xl flex items-center justify-center bg-[#84A98C] transition active:scale-95"><i class="fa-solid fa-plus"></i></button>
            </div>
            <div id="readonly-tip" class="absolute bottom-20 w-full text-center hidden"><span class="bg-gray-800 text-white text-[10px] px-3 py-1 rounded-full opacity-70">åªèƒ½çœ‹ï¼Œä¸èƒ½å¹«å°æ–¹è¨˜å¸³å–”</span></div>
        </div>

        <!-- 4. é¦™è¸é é¢ (é ‚éƒ¨æ­·å²ç‰ˆ) -->
        <div id="page-smoke" class="page bg-[#F9F9F7] relative">
            <header class="pt-10 pb-6 px-6 bg-white rounded-b-[30px] soft-shadow mb-4">
                <button onclick="showPage('page-main')" class="text-gray-400 mb-4 flex items-center gap-2 text-sm"><i class="fa-solid fa-arrow-left"></i> è¿”å›è¨˜å¸³</button>
                <div class="flex justify-between items-start">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-700">é¦™è¸ç®¡ç†</h2>
                        <!-- ğŸ”¥ æ–°å¢ï¼šæŸ¥çœ‹ç¸½æ­·å²æŒ‰éˆ• -->
                        <button onclick="showGlobalHistory()" class="text-xs text-[#84A98C] bg-[#E9F5DB] px-3 py-1 rounded-full mt-2 font-bold hover:bg-[#d4eac0]">
                            <i class="fa-solid fa-clock-rotate-left mr-1"></i> æŸ¥çœ‹ç¸½ç´€éŒ„
                        </button>
                    </div>
                    <div id="smoke-add-area" class="hidden">
                        <button onclick="toggleAddSmoke()" class="bg-[#E9F5DB] text-[#84A98C] w-10 h-10 rounded-full flex items-center justify-center shadow-sm">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                    </div>
                </div>
                
                <div id="add-smoke-box" class="hidden mt-4 bg-gray-50 p-3 rounded-xl animate-fade">
                    <div class="flex gap-2">
                        <input type="text" id="new-smoke-name" class="flex-1 bg-white p-2 rounded-lg text-sm outline-none border border-gray-200" placeholder="è¼¸å…¥é¦™è¸å“ç‰Œåç¨±">
                        <button onclick="addSmokeBrand()" class="bg-[#84A98C] text-white px-4 py-2 rounded-lg text-xs font-bold">æ–°å¢</button>
                    </div>
                </div>
            </header>

            <main id="smoke-list" class="flex-1 overflow-y-auto no-scrollbar px-6 pb-20 space-y-4">
                <div class="text-center text-gray-300 text-xs mt-10">è¼‰å…¥ä¸­...</div>
            </main>
        </div>

        <!-- 5. è¬ç”¨å½ˆçª— (è¨˜å¸³) -->
        <div id="modal-add" class="fixed inset-0 bg-black bg-opacity-30 z-50 hidden items-end sm:items-center sm:justify-center">
            <div class="bg-white w-full sm:w-[450px] sm:rounded-2xl rounded-t-3xl p-6 modal-enter relative">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-gray-600 text-lg"><span id="modal-title">è¨˜ä¸€ç­†</span> <span id="modal-who" class="text-xs ml-2 bg-gray-100 px-2 py-1 rounded text-gray-400"></span></h3>
                    <div class="flex gap-4">
                        <button onclick="deleteTransaction()" id="btn-delete" class="text-red-400 hidden hover:bg-red-50 px-2 rounded"><i class="fa-solid fa-trash-can"></i></button>
                        <button onclick="closeModal()" class="text-gray-400"><i class="fa-solid fa-xmark text-xl"></i></button>
                    </div>
                </div>
                <input type="number" id="input-amount" class="w-full bg-gray-50 p-4 rounded-xl text-3xl font-bold text-gray-700 outline-none mb-4" placeholder="é‡‘é¡">
                <input type="text" id="input-title" class="w-full bg-gray-50 p-4 rounded-xl text-lg text-gray-700 outline-none mb-4" placeholder="å‚™è¨»">
                <div class="flex gap-4 mb-4">
                    <button onclick="setType('expense')" id="btn-exp" class="flex-1 py-3 rounded-xl border bg-red-50 text-red-400 font-bold border-red-200 transition">æ”¯å‡º</button>
                    <button onclick="setType('income')" id="btn-inc" class="flex-1 py-3 rounded-xl border text-gray-400 font-bold border-gray-200 transition">æ”¶å…¥</button>
                </div>
                <button onclick="saveTransaction()" id="btn-submit" class="w-full py-4 bg-gray-800 text-white rounded-xl font-bold shadow-md active:scale-95 transition">å„²å­˜</button>
            </div>
        </div>

        <!-- 6. ç¸½æ­·å²ç´€éŒ„å½ˆçª— (é¦™è¸ç”¨) -->
        <div id="modal-history" class="fixed inset-0 bg-black bg-opacity-30 z-50 hidden items-center justify-center">
            <div class="bg-white w-full max-w-sm rounded-2xl p-6 modal-enter m-4 relative max-h-[80vh] flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-gray-600" id="hist-title">æ¯æ—¥æŠ½è¸çµ±è¨ˆ</h3>
                    <button onclick="closeHistory()" class="text-gray-400"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                <div id="hist-list" class="flex-1 overflow-y-auto space-y-2 pr-2">
                    <!-- æ­·å²åˆ—è¡¨ -->
                </div>
            </div>
        </div>

    </div>

    <script>
        // 1. åˆå§‹åŒ– Firebase
        const firebaseConfig = {
          apiKey: "AIzaSyBeFhH_-YgwjT6ZKPKEn3DbWfkgZ0jMkxM",
          authDomain: "money-c8e66.firebaseapp.com",
          projectId: "money-c8e66",
          storageBucket: "money-c8e66.firebasestorage.app",
          messagingSenderId: "960224276188",
          appId: "1:960224276188:web:647ba7f509fe5b98984e19",
          measurementId: "G-PXP0ZNQY2H"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // å…¨åŸŸè®Šæ•¸
        let myRoomId = localStorage.getItem('myRoomId');
        let myRole = localStorage.getItem('myRole');
        let currentView = myRole || 'Boy';
        let currentType = 'expense';
        let unsubscribe = null;
        let smokeUnsubscribe = null;
        let editingId = null;

        const ALLOWED_ID = "h39862469";
        const ALLOWED_PIN = "1115";

        // 2. å•Ÿå‹• App
        function initApp() {
            if (myRoomId === ALLOWED_ID && myRole) {
                showPage('page-main');
                initListener();
                initSmokeListener(); 
            } else if (myRoomId === ALLOWED_ID) {
                showPage('page-role');
            } else {
                localStorage.clear();
                showPage('page-login');
            }
        }
        initApp();

        // 3. ç™»å…¥
        function handleLogin() {
            const id = document.getElementById('login-id').value.trim();
            const pin = document.getElementById('login-pin').value.trim();
            const msg = document.getElementById('login-msg');
            const btn = document.getElementById('btn-login');

            if (id !== ALLOWED_ID || pin !== ALLOWED_PIN) {
                msg.innerText = "å¸³è™Ÿ/å¯†ç¢¼éŒ¯èª¤"; return;
            }
            btn.innerText = "é©—è­‰ä¸­...";
            
            const roomRef = db.collection("rooms").doc(id);
            roomRef.get().then((doc) => {
                if (!doc.exists) {
                    roomRef.set({ pin: pin, createdAt: firebase.firestore.FieldValue.serverTimestamp() })
                        .then(() => loginSuccess(id));
                } else {
                    loginSuccess(id);
                }
            }).catch((err) => { msg.innerText = "é€£ç·šéŒ¯èª¤"; btn.innerText = "é©—è­‰èº«åˆ†"; });
        }

        function loginSuccess(id) {
            localStorage.setItem('myRoomId', id);
            myRoomId = id;
            showPage('page-role');
        }

        // 4. è¨˜å¸³åˆ—è¡¨
        function initListener() {
            updateUI();
            if(unsubscribe) unsubscribe();

            unsubscribe = db.collection("rooms").doc(myRoomId).collection("transactions")
                .where("who", "==", currentView)
                .onSnapshot((snapshot) => {
                    const list = document.getElementById('tx-list');
                    list.innerHTML = '';
                    let total = 0;

                    if(snapshot.empty) list.innerHTML = '<div class="text-center text-gray-300 text-xs mt-10">é‚„æ²’æœ‰è¨˜å¸³ï¼Œé»æ“Š + æ–°å¢</div>';

                    let docs = [];
                    snapshot.forEach(doc => docs.push({ id: doc.id, ...doc.data() }));

                    docs.sort((a, b) => {
                        let t1 = a.timestamp ? a.timestamp.seconds : 0;
                        let t2 = b.timestamp ? b.timestamp.seconds : 0;
                        return t2 - t1;
                    });

                    docs.forEach(d => {
                        const isExp = d.type === 'expense';
                        const amt = Number(d.amount);
                        if(isExp) total -= amt; else total += amt;

                        let timeStr = "";
                        if(d.timestamp) {
                            const date = d.timestamp.toDate();
                            const mm = (date.getMonth()+1).toString().padStart(2, '0');
                            const dd = date.getDate().toString().padStart(2, '0');
                            const hh = date.getHours().toString().padStart(2, '0');
                            const min = date.getMinutes().toString().padStart(2, '0');
                            timeStr = `${mm}/${dd} ${hh}:${min}`;
                        }
                        const color = isExp ? 'text-[#E5989B]' : 'text-[#84A98C]';
                        
                        list.innerHTML += `
                        <div onclick="openModal('${d.id}', '${d.title}', '${d.amount}', '${d.type}')" 
                             class="bg-white p-4 rounded-2xl flex items-center justify-between soft-shadow mb-3 cursor-pointer hover:bg-gray-50 transition active:scale-95">
                            <div>
                                <p class="font-bold text-gray-700">${d.title}</p>
                                <p class="text-xs text-gray-400 mt-1"><i class="fa-regular fa-clock text-[10px] mr-1"></i>${timeStr} <span class="ml-2 px-1 rounded bg-gray-100">${isExp?'æ”¯å‡º':'æ”¶å…¥'}</span></p>
                            </div>
                            <span class="font-bold ${color} text-lg">${isExp?'-':'+'} ${amt}</span>
                        </div>`;
                    });
                    document.getElementById('total-balance').innerText = total;
                    document.getElementById('total-balance').style.color = currentView === 'Boy' ? '#84A98C' : '#E5989B';
                });
        }

        // 5. ğŸ”¥ é¦™è¸é‚è¼¯
        function initSmokeListener() {
            if(smokeUnsubscribe) smokeUnsubscribe();

            const addArea = document.getElementById('smoke-add-area');
            if (myRole === 'Boy') addArea.classList.remove('hidden'); else addArea.classList.add('hidden');

            smokeUnsubscribe = db.collection("rooms").doc(myRoomId).collection("smokes")
                .onSnapshot((snapshot) => {
                    const list = document.getElementById('smoke-list');
                    list.innerHTML = '';
                    
                    if(snapshot.empty) {
                        list.innerHTML = `<div class="text-center text-gray-300 text-sm mt-10">é‚„æ²’æœ‰ç´€éŒ„ä»»ä½•é¦™è¸å“ç‰Œ</div>`;
                        return;
                    }

                    snapshot.forEach(doc => {
                        const d = doc.data();
                        const todayStr = getTodayStr();
                        let displayToday = d.todayCount;
                        if(d.lastUpdated !== todayStr) displayToday = 0;

                        let actionButtons = '';
                        let deleteBtn = '';
                        let editIcon = ''; 

                        if(myRole === 'Boy') {
                            editIcon = `<button onclick="editStock('${doc.id}', ${d.stock})" class="ml-2 text-gray-300 hover:text-[#84A98C]"><i class="fa-solid fa-pen text-xs"></i></button>`;
                            deleteBtn = `<button onclick="deleteSmokeBrand('${doc.id}')" class="text-gray-300 hover:text-red-400 px-2"><i class="fa-solid fa-trash"></i></button>`;
                            
                            actionButtons = `
                                <div class="flex gap-2 mt-4">
                                    <button onclick="smokeOne('${doc.id}', ${displayToday}, ${d.stock}, '${d.lastUpdated}')" class="flex-1 bg-[#84A98C] text-white py-3 rounded-lg text-sm font-bold active:scale-95 transition flex items-center justify-center gap-2 shadow-sm">
                                        <i class="fa-solid fa-fire"></i> æŠ½ä¸€æ ¹
                                    </button>
                                    <button onclick="updateSmokeStock('${doc.id}', 20)" class="w-1/3 bg-[#E9F5DB] text-[#84A98C] py-3 rounded-lg text-xs font-bold active:scale-95 transition">
                                        + é–‹æ–°åŒ…
                                    </button>
                                </div>
                            `;
                        }

                        list.innerHTML += `
                        <div class="bg-white p-5 rounded-2xl soft-shadow relative mb-4">
                            <div class="flex justify-between items-start mb-2 pr-4">
                                <h3 class="text-lg font-bold text-gray-700">${d.brandName}</h3>
                                ${deleteBtn}
                            </div>
                            
                            <div class="flex justify-between items-center mt-2">
                                <div class="text-center w-1/2 border-r border-gray-100">
                                    <p class="text-xs text-gray-400">ä»Šæ—¥å·²æŠ½</p>
                                    <p class="text-3xl font-bold text-[#84A98C]">${displayToday}</p>
                                </div>
                                <div class="text-center w-1/2">
                                    <p class="text-xs text-gray-400">å‰©é¤˜åº«å­˜</p>
                                    <p class="text-3xl font-bold text-gray-600 flex items-center justify-center">
                                        ${d.stock} ${editIcon}
                                    </p>
                                </div>
                            </div>
                            ${actionButtons}
                        </div>
                        `;
                    });
                });
        }

        function toggleAddSmoke() { document.getElementById('add-smoke-box').classList.toggle('hidden'); }
        function addSmokeBrand() {
            const name = document.getElementById('new-smoke-name').value;
            if(!name) return;
            db.collection("rooms").doc(myRoomId).collection("smokes").add({
                brandName: name, stock: 20, todayCount: 0, lastUpdated: getTodayStr()
            }).then(() => {
                document.getElementById('new-smoke-name').value = ''; toggleAddSmoke();
            });
        }
        function deleteSmokeBrand(id) {
            if(confirm("åˆªé™¤æ­¤å“ç‰Œï¼Ÿ")) db.collection("rooms").doc(myRoomId).collection("smokes").doc(id).delete();
        }
        function editStock(id, current) {
            const newVal = prompt("è«‹è¼¸å…¥æ­£ç¢ºçš„åº«å­˜æ•¸é‡ï¼š", current);
            if(newVal !== null && !isNaN(newVal)) {
                 db.collection("rooms").doc(myRoomId).collection("smokes").doc(id).update({ stock: Number(newVal) });
            }
        }
        function updateSmokeStock(id, amount) {
            db.collection("rooms").doc(myRoomId).collection("smokes").doc(id).update({
                stock: firebase.firestore.FieldValue.increment(amount)
            });
        }

        // ğŸ”¥ åŠŸèƒ½ï¼šæŠ½ä¸€æ ¹ (åŒæ™‚å¯«å…¥ "ç¸½æ­·å²ç´€éŒ„")
        function smokeOne(id, currentToday, currentStock, lastDate) {
            if(currentStock <= 0) { alert("æ²’è¸äº†ï¼"); return; }
            
            const todayStr = getTodayStr();
            let newToday = currentToday + 1;
            if (lastDate !== todayStr) newToday = 1;

            // 1. æ›´æ–°è©²å“ç‰Œçš„åº«å­˜èˆ‡ä»Šæ—¥æ•¸
            db.collection("rooms").doc(myRoomId).collection("smokes").doc(id).update({
                stock: firebase.firestore.FieldValue.increment(-1),
                todayCount: newToday,
                lastUpdated: todayStr
            });

            // 2. å¯«å…¥ "ç¸½æ­·å²ç´€éŒ„" (smoke_history)
            const globalHistRef = db.collection("rooms").doc(myRoomId).collection("smoke_history").doc(todayStr);
            globalHistRef.set({
                total: firebase.firestore.FieldValue.increment(1),
                date: todayStr
            }, { merge: true });
        }

        // ğŸ”¥ åŠŸèƒ½ï¼šé¡¯ç¤ºç¸½æ­·å²ç´€éŒ„
        function showGlobalHistory() {
            const modal = document.getElementById('modal-history');
            const list = document.getElementById('hist-list');
            modal.style.display = 'flex';
            list.innerHTML = '<div class="text-center text-xs text-gray-300 mt-4">è¼‰å…¥ä¸­...</div>';

            db.collection("rooms").doc(myRoomId).collection("smoke_history")
                .orderBy("date", "desc").limit(14) // é¡¯ç¤ºæœ€è¿‘ 14 å¤©
                .get().then(snapshot => {
                    list.innerHTML = '';
                    if(snapshot.empty) {
                        list.innerHTML = '<div class="text-center text-xs text-gray-300 mt-4">æš«ç„¡æ­·å²ç´€éŒ„<br>(å¾ä»Šå¤©é–‹å§‹ç´¯è¨ˆ)</div>';
                        return;
                    }
                    snapshot.forEach(doc => {
                        const d = doc.data();
                        list.innerHTML += `
                            <div class="flex justify-between items-center border-b border-gray-100 py-3">
                                <span class="text-gray-500 font-medium">${d.date}</span>
                                <span class="text-[#84A98C] font-bold">${d.total} æ ¹</span>
                            </div>
                        `;
                    });
                });
        }
        function closeHistory() { document.getElementById('modal-history').style.display = 'none'; }


        // 6. è¨˜å¸³å­˜æª”
        function saveTransaction() {
            const amt = document.getElementById('input-amount').value;
            const title = document.getElementById('input-title').value;
            if(!amt || !title) return;
            const collectionRef = db.collection("rooms").doc(myRoomId).collection("transactions");
            const btn = document.getElementById('btn-submit');
            btn.innerText = "è™•ç†ä¸­...";

            if (editingId) {
                collectionRef.doc(editingId).update({ amount: Number(amt), title: title, type: currentType }).then(() => closeModal());
            } else {
                collectionRef.add({
                    who: myRole, amount: Number(amt), title: title, type: currentType, timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    closeModal(); document.getElementById('input-amount').value = ''; document.getElementById('input-title').value = '';
                });
            }
        }
        function deleteTransaction() { if(editingId && confirm("åˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ")) db.collection("rooms").doc(myRoomId).collection("transactions").doc(editingId).delete().then(() => closeModal()); }

        // Utils
        function getTodayStr() { const d = new Date(); return d.toISOString().split('T')[0]; }
        function selectRole(role) { 
            localStorage.setItem('myRole', role); myRole = role; currentView = role; 
            showPage('page-main'); initListener(); initSmokeListener();
        }
        function switchView(role) { currentView = role; initListener(); }
        function showPage(id) { document.querySelectorAll('.page').forEach(e => e.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function openModal(id, title, amt, type) {
            document.getElementById('modal-add').style.display='flex'; document.getElementById('modal-who').innerText = myRole;
            const btnDel = document.getElementById('btn-delete'); const btnSub = document.getElementById('btn-submit');
            if(id) {
                editingId=id; document.getElementById('input-title').value=title; document.getElementById('input-amount').value=amt; setType(type);
                document.getElementById('modal-title').innerText="ç·¨è¼¯";
                if(currentView===myRole){ btnSub.style.display='block'; btnDel.style.display='block'; btnSub.innerText="æ›´æ–°"; } else { btnSub.style.display='none'; btnDel.style.display='none'; }
            } else {
                editingId=null; document.getElementById('modal-title').innerText="è¨˜ä¸€ç­†";
                btnDel.style.display='none'; btnSub.innerText="å„²å­˜"; btnSub.style.display='block'; setType('expense');
            }
        }
        function closeModal() { document.getElementById('modal-add').style.display = 'none'; }
        function setType(t) { 
            currentType = t; 
            document.getElementById('btn-exp').className = t==='expense' ? "flex-1 py-3 rounded-xl border bg-red-50 text-red-400 font-bold border-red-200" : "flex-1 py-3 rounded-xl border text-gray-400 font-bold border-gray-200"; 
            document.getElementById('btn-inc').className = t==='income' ? "flex-1 py-3 rounded-xl border bg-blue-50 text-blue-400 font-bold border-blue-200" : "flex-1 py-3 rounded-xl border text-gray-400 font-bold border-gray-200"; 
        }
        function logout() { if(confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) { localStorage.clear(); location.reload(); } }
        function updateUI() {
             const fab = document.getElementById('fab-add');
             document.getElementById('btn-go-smoke').classList.remove('hidden');
             if(currentView !== myRole) { fab.style.display='none'; document.getElementById('readonly-tip').style.display='block'; }
             else { fab.style.display='flex'; document.getElementById('readonly-tip').style.display='none'; }
             document.getElementById('avatar-Boy').style.opacity = currentView === 'Boy' ? '1' : '0.5';
             document.getElementById('avatar-Girl').style.opacity = currentView === 'Girl' ? '1' : '0.5';
        }
    </script>
</body>
</html>